---
work_package_id: "WP02"
title: "Comment Ingestion System"
lane: "planned"
dependencies: ["WP01"]
---

# WP02: Comment Ingestion System

## Objective
Build the system that receives and processes Figma comments.

## Context
Figma provides two ways to receive comments:
1. **Webhooks** - Real-time notifications for `FILE_COMMENT` events
2. **Polling** - Periodically calling `get_comments` API

We need to support both, with webhooks as primary and polling as fallback.

## Tasks

1. **Implement webhook receiver**
   - Endpoint: `POST /api/webhooks/figma`
   - Handle `FILE_COMMENT` event type
   - Validate webhook signature (if Figma provides one)
   - Enqueue tasks immediately on receipt

2. **Implement polling fallback**
   - Interval: configurable (default 30 seconds)
   - Call `get_comments` API
   - Diff against last-seen to find new comments

3. **Add comment deduplication**
   - Store last-seen comment IDs per file_key
   - Prevent double-processing from webhook retries
   - Handle overlap between webhook and polling

4. **Implement cursor tracking**
   - Track `last_processed_at` timestamp per file
   - Persist to storage (`~/.figyah/cursors.json`)
   - Resume from cursor on restart

## Deliverables

- [ ] `figma-mcp-server/src/comments/ingestion.ts`
- [ ] `figma-mcp-server/src/comments/cursor.ts`
- [ ] Webhook endpoint in bridge server
- [ ] Unit tests for deduplication logic

## Acceptance Criteria

- Webhook receives and processes FILE_COMMENT events
- Polling detects new comments within interval
- Same comment processed only once (no duplicates)
- System resumes correctly after restart
- Both methods can run simultaneously without issues

## Technical Notes

```typescript
// Cursor tracking
interface CommentCursor {
  fileKey: string;
  lastCommentId: string;
  lastProcessedAt: string;  // ISO timestamp
}

// Deduplication
const processedComments = new Set<string>();

function shouldProcess(commentId: string): boolean {
  if (processedComments.has(commentId)) return false;
  processedComments.add(commentId);
  return true;
}
```
