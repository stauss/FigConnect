---
work_package_id: "WP03"
title: "Comment Parser & Queue"
lane: "planned"
dependencies: ["WP02"]
---

# WP03: Comment Parser & Queue

## Objective
Parse incoming comments into structured tasks and manage their lifecycle.

## Context
Once comments are ingested (WP02), they need to be parsed into actionable tasks with all relevant context extracted. These tasks then flow through a state machine for execution.

## Tasks

1. **Implement Comment → Task parser**
   - Extract all relevant fields from Figma comment
   - Normalize text (trim, handle newlines)
   - Identify task type from command text

2. **Extract task context**
   - `file_key` - Which file
   - `comment_id` - Unique identifier
   - `parent_id` / `thread_id` - For threaded replies
   - `author` - Who wrote the comment
   - `created_at` - Timestamp
   - `message` - The actual command text
   - `client_meta` - Position data for node resolution

3. **Determine task properties**
   - `priority` - Based on optional keywords (e.g., "urgent")
   - `scope` - Single-node vs multi-node operation
   - `isDestructive` - Requires confirmation

4. **Implement task queue with state machine**
   - States: `queued` → `in_progress` → `done` | `failed` | `needs_input` | `canceled`
   - Track: durations, errors, command IDs, resulting node IDs
   - Persist queue state to storage

## Deliverables

- [ ] `figma-mcp-server/src/comments/parser.ts`
- [ ] `figma-mcp-server/src/queue/comment-queue.ts`
- [ ] Type definitions for task structure
- [ ] Unit tests for parser and queue

## Acceptance Criteria

- Parser extracts all required fields from comments
- Tasks correctly identified as destructive or not
- Queue correctly transitions between states
- Failed tasks include error information
- Queue persists across restarts

## Technical Notes

```typescript
// Task structure
interface CommentTask {
  id: string;
  fileKey: string;
  commentId: string;
  threadId?: string;
  author: string;
  command: string;
  clientMeta?: { x: number; y: number; node_id?: string };
  priority: 'normal' | 'high';
  scope: 'single' | 'multi';
  isDestructive: boolean;
  state: TaskState;
  createdAt: string;
  startedAt?: string;
  completedAt?: string;
  error?: string;
  resultNodeIds?: string[];
}

type TaskState = 'queued' | 'in_progress' | 'needs_input' | 'done' | 'failed' | 'canceled';
```
